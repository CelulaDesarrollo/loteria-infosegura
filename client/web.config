<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <!-- 1. CORRECCIÓN DEL DOCUMENTO PREDETERMINADO -->
        <defaultDocument>
            <files>
                <!-- Removemos los defaults genéricos de IIS -->
                <remove value="iisstart.htm" />
                <remove value="Default.asp" />
                <remove value="Default.htm" />
                <!-- Y aseguramos que index.html sea el primero -->
                <add value="index.html" />
            </files>
        </defaultDocument>

        <!-- 2. REGLAS DE REESCRITURA DE URL (CRUCIAL PARA NEXT.JS SSG) -->
        <rewrite>
            <rules>
                <!-- Regla para rutas sin extensión -->
                <!-- Esta regla permite que URLs como /room/main_loteria carguen el index.html correcto -->
                <rule name="Next.js Static Paths" stopProcessing="true">
                    <match url="^(.*)/?$" ignoreCase="true" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                        <add input="{REQUEST_URI}" pattern="\.html$" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="{R:1}/index.html" />
                </rule>
            </rules>
        </rewrite>

        <!-- 3. CONFIGURACIÓN DE TIPOS MIME (Opcional, pero bueno para archivos .json) -->
        <staticContent>
            <mimeMap fileExtension=".json" mimeType="application/json" />
        </staticContent>

        <!-- Habilitar compresión -->
        <httpCompression directory="%SystemDrive%\inetpub\temp\IIS Temporary Compressed Files">
          <scheme name="gzip" dll="%Windir%\system32\inetsrv\gzip.dll" staticCompressionLevel="9" />
          <dynamicTypes>
            <add mimeType="text/html" enabled="true" />
            <add mimeType="text/plain" enabled="true" />
            <add mimeType="application/json" enabled="true" />
            <add mimeType="application/javascript" enabled="true" />
          </dynamicTypes>
        </httpCompression>
        <staticContent>
          <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="31536000" />
        </staticContent>

        <!-- Reescribir rutas dinámicas a index.html (SPA fallback) -->
        <rewrite>
          <rules>
            <!-- No reescribir archivos/carpetas existentes -->
            <rule name="ExistingFileOrFolder" stopProcessing="true">
              <match url="^(.*)$" />
              <conditions logicalGrouping="MatchAll">
                <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
              </conditions>
              <action type="Rewrite" url="/" />
            </rule>
          </rules>
        </rewrite>

        <!-- Headers de seguridad -->
        <httpProtocol>
          <customHeaders>
            <add name="X-Content-Type-Options" value="nosniff" />
            <add name="X-Frame-Options" value="DENY" />
            <add name="X-XSS-Protection" value="1; mode=block" />
            <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
          </customHeaders>
        </httpProtocol>
    </system.webServer>
</configuration>